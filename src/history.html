<script type="text/javascript">
	var historyCount = 0;

	var listHistory = function() {
		$.post('/history','action=list').done(
						function(data) {
							if (data.status === 'Success.') {
								for (var i = historyCount; i < data.history.length; i++) {
									insertHistoryItem(data.history[i]);
								}

							} else {
								var alert = "<tr><td colspan=\"4\"><div class=\"alert alert-danger alert-dismissible\" role=\"alert\"><button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button>"
										+ data.status + "</div></td></tr>";
								$('#history-list tbody').append(alert);
							}
						}).fail(function(data){
								var alert = "<tr><td colspan=\"4\"><div class=\"alert alert-danger alert-dismissible\" role=\"alert\"><button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button>"
										+ "Connection error!</div></td></tr>";
								$('#history-list tbody').append(alert);							
						});
	}

	var insertHistoryItem = function(data) {
		var id = 'l' + historyCount;

		var newHistoryItem = document.getElementById('history-template').cloneNode(true);
		newHistoryItem.id = id;
		newHistoryItem.style.display = 'none';

		$('#history-list tbody').append(newHistoryItem);
		historyCount++;

		$id = $(newHistoryItem);
		fillInHistoryItem($id, data);

		$id.slideDown(400)

		return id;
	}

	var fillInHistoryItem = function($id, data) {
		$id.find('input[name=date]').val(data.date);
		$id.find('input[name=title]').val(data.title);
		for (var i = 0; i < data.urls.length; i++) {
			var html = '<li><a href="' + data.urls[i] + '">' + data.urls[i] + '</a></li>';
			$id.find('ul.linklist').append(html);
		}
		$id.find('button').each(function() {
			$(this).data('item-id', $id);
		});
	}

	var clearHistory = function() {
		$.post('/history', 'action=clear').done(function(data) {
			if (data.status === 'Success.') {
				for (var i = 0; i < historyCount; i++) {
					$('#l' + i).remove();
				}
				historyCount = 0;
			} else {
				notify($('#clear-history'), '', data.status, 'bg-danger', 4000);
			}
		}).fail(function() {
			notify($('#clear-history'), '', 'Connection Error.', 'bg-danger', 4000);
		});

	}

	var reDownload = function($id) {
		var index = parseInt($id.prop('id').substring(1));

		$.post('/history', 'action=redownload&data=' + index).done(function(data) {
			if (data.status === 'Success.') {
				notify($id.find('button.re-dl'), '', data.status, 'bg-success', 2000);
			} else {
				notify($id.find('button.re-dl'), '', data.status, 'bg-danger', 4000);
			}
		}).fail(function(data) {
			notify($id.find('button.re-dl'), '', data.status, 'bg-danger', 4000);
		});
	}

	var continuousRefresh = function() {
		listHistory();
		setTimeout(continuousRefresh, 10000);
	}

	$(document).ready(function() {

		$('[data-toggle="tooltip"]').tooltip();

		$('#add').click(function() {
			addLinktype();
		});
		$('#clear-history').click(function() {
			clearHistory();
		});
		$('#refresh-history').click(function() {
			listHistory();
		});
		$('#history-list').on('click', 'button.details', function() {
			toggleShow($(this).data('item-id'));
		});
		$('#history-list').on('click', 'button.re-dl', function() {
			reDownload($(this).data('item-id'));
		});
		continuousRefresh();
	});
</script>
<p>
	<button id="refresh-history" class="btn btn-info">Refresh History</button>
	<button id="clear-history" class="btn btn-danger"
		data-toggle="popover">Clear History</button>
</p>
<div class="panel panel-default">
	<div class="panel-body">
		<table id="history-list" class="table table-striped">
			<thead>
				<tr>
					<th style="width: 250px;"">Date</th>
					<th>Filter Title</th>
					<th style="width: 75px;">Details</th>
					<th style="width: 100px;">Re-download</th>
				</tr>
			</thead>
			<tbody>
			</tbody>
		</table>
	</div>
</div>
<table style="display: none;">
	<tr id="history-template" class="history-item" style="display: none;">
		<td><input name="date" class="form-control" disabled></td>
		<td><input name="title" class="form-control" disabled>
			<div class="panel panel-default edit" style="display: none;">
				<div class="panel-body">
					<ul class="linklist"></ul>
				</div>
			</div></td>
		<td><button type="button" class="btn btn-info details">Details</button></td>
		<td>
			<button type="button" class="btn btn-primary re-dl">Re-download</button>
		</td>
	</tr>
</table>